import { CodeSurfer, CodeSurferColumns, Step } from "code-surfer";
import { Notes, Appear } from "mdx-deck";
import { vsDark } from "@code-surfer/themes";
import { nightOwl } from "@code-surfer/themes";
import { images } from "./images";
import { future, prism } from "mdx-deck/themes";
import myTheme from "./theme";
import "prismjs/components/prism-gherkin";
import CenterElement from "./layout/center-element.js";

export const themes = [future, myTheme];

## UI Testing Real Life Experience

<img style={{ height: "60vh" }} src={images.uiTesting} />

Marco Scapoli, Roberto Massimini

---

## Agenda

1. Crushtravel
1. Testing Theory
1. Testing tools / Cypress
1. Integration tests
1. E2E tests
1. Unit tests

---

# Crushtravel

<div>
  "Crush Travels S.r.l. mette a disposizione degli utenti un servizio che consente di partecipare alla Community, condividere, pubblicare e
  consultare informazioni, percorsi e consigli di viaggio."
</div>

<div style={{ "margin-top": "50px" }}>
  <img style={{ display: "inline-block", "margin-right": "10px", height: "30vh" }} src={images.homepage} />
  <img style={{ display: "inline-block", "margin-right": "10px", height: "30vh" }} src={images.creator} />
  <img style={{ display: "inline-block", height: "30vh" }} src={images.itinerary} />
</div>

---

## Usual Friday

<img style={{ height: "60vh" }} src={images.slack} />

---

# Testing Theory

<Notes>

- Evaluate Pros/cons

</Notes>

---

## Why should we test (automatically) our code?

<Appear>

- To verify that it meets the **requirements**
- To avoid **regressions** after refactoring
- Manual tests are **slow** and **error prone**
- As a **flow descriptor**
- To have a way to test specific cases that are difficult to test manually

</Appear>

<Notes>

- Documentation: new developers can easily play with the code
- Example: long procedure to reach desided state

</Notes>

---

## Test Types: End To End (E2E)

Test the whole application (frontend + backend) like a user (usually from the browser)

---

## Test Types: End To End (E2E)

- ‚úÖ Great **confidence** that everything works as expected
- ‚úÖ Indipendent from the **code structure**
- ‚ùå **Slow**
- ‚ùå Difficult to make them **deterministic**
- ‚ùå Less **specific**
- ‚ùå No **TDD**

---

## Test Types: Unit tests

Test a **unit** of our code in **isolation** from the rest.

What is a unit?! ü§î

<Notes>

Different units: classes, functions, components

</Notes>

---

## Test Types: Unit tests

- ‚úÖ **Fast**
- ‚úÖ Very **specific**
- ‚úÖ Easy to make them **deterministic**
- ‚úÖ **TDD**
- ‚ùå Less **confidence** that everything works as expected
- ‚ùå Tied to the **code structure**
- ‚ùå Often require to **mock** a lot of things

---

## Test Types: Integration tests

Test a group of units and tests their behavior as a whole.

Usually in a frontend application we mean mocking the backend APIs

---

## Test Types: Integration tests

- ‚úÖ Easy to make them **deterministic**
- ‚úÖ Almost indipendent from the **code structure**
- ‚úÖ Require to **mock** only external APIs
- ‚úÖ **TDD**
- ‚ùå Less **confidence** that everything works as expected
- **Faster** than E2E tests, but **slower** than Unit tests
- Less **specific** than Unit tests, but more specific than E2E tests

---

<CenterElement>
  <img src={images.unitIntegration} style={{ height: "60vh" }} />
</CenterElement>

---

## Testing Pyramid

<img src={images.pyramid1} style={{ height: "70vh" }} />

<small>

https://martinfowler.com/bliki/TestPyramid.html

https://testing.googleblog.com/2015/04/just-say-no-to-more-end-to-end-tests.html

</small>

---

## Testing Trophy

<CenterElement>
  <img src={images.pyramid2} style={{ height: "70vh" }} />
</CenterElement>

https://kentcdodds.com/blog/write-tests

<Notes>

- E2E: Happy path
- Integration: corner cases
- Unit: Businnes logic

</Notes>

---

# Testing tools / Cypress

---

## [Cypress](https://www.cypress.io/)

- ‚úÖ Open Source
- ‚úÖ Test Runner in the browser
- ‚úÖ Great documentation
- ‚úÖ Great ecosystem (guides, plugins, resources)
- ‚ùå Not crossbrowser (only Chrome, Edge and Firefox)
- ‚ùå Some important issues not yet resolved
- ‚ùå Some features are difficult to set up (Typescript, code coverage)

---

## Cypress Directory structure

```
‚îú‚îÄ‚îÄ cypress
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ fixtures  <------ Mocked Data
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tests     <------ Our tests
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ plugins   <------ Plugins/extensions
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ support   <------ Utilities and custom commands
‚îî‚îÄ‚îÄ cypress.json  <------ Cypress configuration
```

---

## Configure Cypress

```json
// cypress.json
{
  "baseUrl": "http://localhost:4200"
  "integrationFolder": "cypress/tests"
}
```

---

## Launch Cypress

```json
// package.json
{
    "scripts": {
        ...,
        "cy:open": "cypress open",
        "cy:run": "cypress run"
    }
}
```

---

<CodeSurfer theme={nightOwl}>

```ts file=./code/test-structure.ts title="Test file structure"

```

```ts 3:3 file=./code/test-structure.ts subtitle="Group"

```

```ts 4:18 file=./code/test-structure.ts subtitle="Hooks"

```

```ts 20:30 file=./code/test-structure.ts subtitle="Tests"

```

</CodeSurfer>

---

## Chains of commands

- Cypress is based on [chains of commands](https://docs.cypress.io/guides/core-concepts/introduction-to-cypress.html#Chains-of-Commands)
  ```ts
  cy.get("input.post-title").clear().type("My First Post");
  ```
- Some commands can be chained, others cannot
- Asynchronous (~ Promises) with automatic waiting

<Notes>

Focus on automatic waiting and retryability

</Notes>

---

<CodeSurfer theme={nightOwl}>

```ts title="Assertions" subtitle="Single Assertion on an element"
cy.get("button").click().should("have.class", "active");
```

```ts title="Assertions" subtitle="Negative Assertion on an element"
cy.get("#modal").should("not.exist");
```

```ts title="Assertions" subtitle="Multiple Assertions on an element"
cy.get("#header a").should("have.class", "active").and("have.attr", "href", "/users");
```

```ts title="Assertions" subtitle="Single assertion on an object"
cy.request("/users/1").its("body").should("deep.eq", { name: "Jane" });
```

```ts title="Assertions" subtitle="Explicit form"
cy.get("tbody tr:first").should(($tr) => {
  expect($tr).to.have.class("active");
  expect($tr).to.have.attr("href", "/users");
});
```

</CodeSurfer>

<Notes>

Focus on retryability of should command

</Notes>

---

## Selecting Elements

1. Prefer selectors based on user perspective like:
   - `cy.findByLabelText`, `cy.findByPlaceholderText`, `cy.findByTitle`
     from [Cypress Testing Library](https://testing-library.com/docs/cypress-testing-library/intro)
   - `cy.contains` from Cypress
2. If not possible, use `cy.findByTestId` from Cypress Testing Library
3. If not possible, use CSS selectors

---

<CodeSurferColumns themes={[nightOwl, nightOwl]}>

<Step subtitle="findByLabelText">

```html
<!-- page.html -->

<label for="username">Username</label>
<input id="username" />
```

```ts
// spec.ts

cy.findByLabelText(/username/i);
```

</Step>

<Step subtitle="findByTitle">

```html
<!-- page.html -->

<button type="button" class="btn btn-danger" title="Delete">
  <i class="fa fa-trash"></i>
</button>
```

```ts
// spec.ts

cy.findByTitle(/delete/i);
```

</Step>

<Step subtitle="findByTestId">

```html
<!-- page.html -->

<div data-testid="chart-container">
  <!-- ... -->
</div>
```

```ts
// spec.ts

cy.findByTestId("chart-container");
```

</Step>

<Step subtitle="CSS selector">

```html 3:5
<!-- page.html -->

<div class="modal-body">
  <!-- ... -->
</div>
```

```ts
// spec.ts

cy.get(".modal-body");
```

</Step>

</CodeSurferColumns>

---

<CodeSurfer theme={nightOwl}>

```ts title="Tip: Share code between tests and between app and tests"
// cypress/support/selectors.ts
export const MODAL_BODY_CLASS = ".modal-body";

// cypress/integration/my-test.ts
import { MODAL_BODY_CLASS } from "cypress/support/selectors.ts";

cy.get(MODAL_BODY_CLASS);
```

</CodeSurfer>

---

<CodeSurfer theme={nightOwl}>

```ts title="Tip: Share code between tests and between app and tests"
// cypress/support/utils.ts
export function fillUsername(username: string) {
  cy.findByLabelText(/username/i)
    .clear()
    .type(username);
}

// cypress/integration/my-test.ts
import { fillUsername } from "cypress/support/utils.ts";

fillUsername("bender");
```

</CodeSurfer>

---

## Tip: Custom Commands

We can create [custom commands](https://docs.cypress.io/api/cypress-api/custom-commands.html), and use them in a Cypress Chain.

Useful if the code is reused a lot in our tests and it is more comfortable to use it inside a chain, or if we want to control the output in the test runner.

---

<CodeSurfer theme={nightOwl}>

```ts file=./code/cypress-commands.ts title="Cypress custom commands"

```

```ts 3:7 file=./code/cypress-commands.ts subtitle="Accept dialog command"

```

</CodeSurfer>

---

## [Tip: Await, don't sleep](https://docs.cypress.io/guides/references/best-practices.html#Unnecessary-Waiting)

‚ùå Anti-Pattern: Waiting for arbitrary time periods using cy.wait(Number).

‚úÖ Best Practice: Use route aliases or assertions to guard Cypress from proceeding until an explicit condition is met.

Check also [Cypress Wait Until Plugin](https://github.com/NoriSte/cypress-wait-until)

---

<CodeSurfer theme={nightOwl}>

```ts title="Await, don't sleep"
cy.get("#fetch").click();
cy.wait(4000); // <--- this is unnecessary
cy.get("table tr").should("have.length", 2);
```

```ts
cy.intercept("POST", "/api", (req) => {
  if (req.body.operationName === "IsEmailAvailable") {
    req.alias = "gqlIsEmailAvailableQuery";
    req.reply({ isEmailAvailable: false });
  }
});
cy.get("#fetch").click();
cy.wait("@gqlIsEmailAvailableQuery"); // <--- wait explicitly for this mutation
cy.get("table tr").should("have.length", 2);
```

</CodeSurfer>

---

## [TIP: Clean state in the beforeEach hook](https://docs.cypress.io/guides/references/best-practices.html#Using-after-or-afterEach-hooks)

‚ùå Anti-Pattern: Using after or afterEach hooks to clean up state.

‚úÖ Best Practice: Clean up state before tests run.

---

# Integration tests

---

## Integration tests

- [Stub network requests](https://docs.cypress.io/guides/guides/network-requests.html) to backend APIs and Keycloak.
- Test are completely indipendent from external resources, they are fast and we can easily test edge cases

---

<CodeSurfer theme={nightOwl}>

```ts file=./code/intercept.ts title="Stubbing request"

```

```ts 2:2 file=./code/intercept.ts title="Stubbing request" subtitle="Intercept"

```

```ts 3:15 file=./code/intercept.ts title="Stubbing request" subtitle="Switch"

```

```ts 7:7 file=./code/intercept.ts  title="Stubbing request" subtitle="Fixture"

```

```ts 17:17 file=./code/intercept.ts  title="Stubbing request" subtitle="Call API"

```

</CodeSurfer>

---

<CodeSurfer theme={nightOwl}>

```ts file=./code/integration1.ts title="Integration test example"

```

```ts 2:25 file=./code/integration1.ts title="Integration test example" subtitle="intercept üõ∞"

```

```ts 4:7 file=./code/integration1.ts title="Integration test example" subtitle="expectBody check üîç"

```

```ts 8:24 file=./code/integration1.ts title="Integration test example" subtitle="directly provide the response object"

```

```ts 27:28 file=./code/integration1.ts  title="Integration test example" subtitle="Cypress in action! üí™"

```

```ts 30:32 file=./code/integration1.ts  title="Integration test example" subtitle="Come on baby, click my button... üòè"

```

```ts 34:34 file=./code/integration1.ts  title="Integration test example" subtitle="...waiting for the aliased resource ‚è±"

```

```ts 36:36 file=./code/integration1.ts  title="Integration test example" subtitle="Final check üèÅ"

```

</CodeSurfer>

# E2E tests

---

## E2E Tests

- Test the whole system (frontend, backend, DB, ...)
- Mock only external parts (e.g. SMTP Server, Devices, External APIs...)
- Need the possiblity to have a clean state before tests execution

---

## Clean state

There are many ways, depending on the project. Examples:

- For testing **before the deploy**
  - Setup a clean environment (even a local one with `docker-compose`)
  - Script for put the DB in a clean state before each test
- If not possible, E2E tests can be run on the **deployed version** on the dev environment
  - Have a way to have a clean state before each test
  - e.g. in a multi-tenant application have a "Test" tenant and delete all linked records before each test

---

## Cypress task

Create a [Cypress task](https://docs.cypress.io/api/commands/task.html) running in Node

```ts
// plugins/index.js
module.exports = (on, config) => {
  on('task', {
    cleanupDb() { ... }
  })
}
```

---

# Unit tests

---

## Unit tests

- Test a function, a class, or a component in **isolation**
- For testing **complex business logic** in a more convenient way, or for logic that cannot be tested in another way (e.g. charts)
- For testing **shared components** that are indipendent from services

---

## Component Unit Testing

[Testing components](https://docs.cypress.io/plugins/#component-testing) in isolation
is an experimental feature of Cypress, we can try to use it only if we found that
it could be really useful.

---

<CenterElement>
  <img style={{ height: "50vh" }} src={images.demotime} />
</CenterElement>

---

> ‚ÄúUnit testing is a lot like going to the gym‚Äù

‚Äì [A random guy on Stackoverflow](https://stackoverflow.com/a/69263/9891450)

---

## Links

- https://github.com/NoriSte/ui-testing-best-practices
- https://noriste.github.io/reactjsday-2019-testing-course/
- https://www.facebook.com/1678427052369994/videos/2312725798938924/
- https://testingjavascript.com/
- https://github.com/goldbergyoni/javascript-testing-best-practices
- https://glebbahmutov.com/blog/
- https://kentcdodds.com/blog/

---

<CenterElement>
  <img style={{ height: "50vh" }} src={images.questions} />
</CenterElement>

---

<CenterElement>
  <img style={{ height: "50vh" }} src={images.thankyou} />
</CenterElement>

---

# Bonus Content

---

## Test Desiderata (1/2)

- **Isolated** ‚Äî tests should return the same results regardless of the order in which they are run.
- **Composable** ‚Äî if tests are isolated, then I can run 1 or 10 or 100 or 1,000,000 and get the same results.
- **Deterministic** ‚Äî if nothing changes, the test result shouldn‚Äôt change.
- **Behavioral** ‚Äî tests should be sensitive to changes in the behavior of the code under test. If the behavior changes, the test result should change.
- **Structure-insensitive** ‚Äî tests should not change their result if the structure of the code changes.
- **Specific** ‚Äî if a test fails, the cause of the failure should be obvious.

https://medium.com/@kentbeck_7670/test-desiderata-94150638a4b3

<Notes>

- Always a tradeoff, impossibile to have all of these
- Why isolate? Understand where is the error, re-run same test
- Non deterministic: global state (e.g. user register), date-time (e.g. dst), concurrency, ...

</Notes>

---

## Test Desiderata (2/2)

- **Fast** ‚Äî tests should run quickly.
- **Writable** ‚Äî tests should be cheap to write relative to the cost of the code being tested.
- **Readable** ‚Äî tests should be comprehensible for reader, invoking the motivation for writing this particular test.
- **Automated** ‚Äî tests should run without human intervention.
- **Predictive** ‚Äî if the tests all pass, then the code under test should be suitable for production.
- **Inspiring** ‚Äî passing the tests should inspire confidence

https://medium.com/@kentbeck_7670/test-desiderata-94150638a4b3

---

## Code coverage

- How much of our code is executed during tests
- There is no **magic number**
- Good coverage does not mean good tests
- Useful during **code reviews** to check if critical paths are tested

https://www.atlassian.com/continuous-delivery/software-testing/code-coverage

---

<CodeSurfer theme={nightOwl}>

```gherkin file=./code/bdd.feature title="BDD / Gherkin"

```

</CodeSurfer>

---

<CodeSurfer theme={nightOwl}>

```js file=./code/bdd.js title="Gherkin + Cypress"

```

</CodeSurfer>

---
